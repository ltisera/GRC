<html>
    <head>
        <script src="/js/jquery-3.3.1.js"></script>
        <script>
            $(function(){
                $("#includedContent").load("/header1");
            });
            var uDataGlobal 
            var idGrupoActual = 0

            

            $(document).ready(function(){
                
                $("#btnEnviar").click(publicarReferencia);
                $("#btnCrearGrupo").click(agregarGrupo);
                
                $("#btnTST").click(tstResponse);
                
                $("#btnInvitarUsuario").click(invitarUsuarioAGrupo)

                misCookies = document.cookie
                listaCookies = misCookies.split(";")
                for (i in listaCookies) {
                    busca = listaCookies[i].search("idUsuarioLogueado");
                    if (busca > -1) {
                        micookie=listaCookies[i]
                        igual = micookie.indexOf("=");
                        valor = micookie.substring(igual+1);
                        idUsuarioLogueado = valor;
                    }
                }
                primeraCarga();
                
                $("body").on("click",".btnGrupos",function(){
                    document.cookie = "idGrupoLogueado=" + this.id.substring(this.id.indexOf("=")+1);
                    window.location.href = ('http://localhost:5000/inicio')
                });


                $.ajax({
                    async: true,
                    data : {
                        "usuario" : valor,
                    },
                    url : "cargarListaGrupo",
                    type : "POST",
                    beforeSend : function() {
                        $('#gruposLista').html("Cargando Grupos");
                    },
                    success : function(response) {
                        $('#gruposLista').html(response);
                        uDataGlobal = response[0];
                        console.log(response);
                        $("#columnaIzquierda").append('<br><img id = "IMGagregar" div="grupoFoto" class="img-circle GrupIMG" src="https://image.flaticon.com/icons/svg/25/25340.svg" alt="Generic placeholder image" width="50" height="50"><br>'+ "AGREGAR");
                        if(response[0]==null){
                            console.log("SOY NULL");
                        }
                        else{
                            for(i=0; i < response[0].length; i++){
                            var nombre = response[0][i][1]
                            if(nombre.length > 7){
                                nombre = response[0][i][1].slice(0, 5) + "..."
                            }
                            
                            $("#columnaIzquierda").append('<br><img id = "IMG'+String(i)+'" div="grupoFoto" class="img-circle GrupIMG" src="https://images.emojiterra.com/google/android-oreo/512px/1f625.png" alt="Generic placeholder image" width="50" height="50"><br>'+ nombre);
                            $("#IMG"+i).data('idGrupo', String(response[0][i][0]));
                            $("#IMG"+i).data('elNombre', String(response[0][i][1]));
                            $("#IMG"+i).data('laDescripcion', String(response[0][i][2]));
                            $("#IMG"+i).data('posEnArray', i);

                            $("#IMG"+i).tooltip({title: String(response[0][i][2]), trigger: "hover", placement: "right"});
                            }
                        }

                    },
                    error : function(response) {
                        $('#divUsuarioSinGrupo').show()
                        $.ajax({
                            async: true,
                            url: "traerTodosGrupos",
                            success: function(response){
                                $('#lblCantGrupos').text(response.length);
                                console.log(response);
                                var opcion = document.createElement("option");
                                $('#lstGrupos').empty();
                                opcion.text = "Seleccione un grupo"
                                opcion.value = "vacio"
                                $('#lstGrupos').append(opcion);
                                for (i = 0; i < response.length;i++){
                                    var opcion = document.createElement("option");
                                    opcion.text = response[i][1];
                                    opcion.value = i
                                    $('#lstGrupos').append(opcion);
                                    console.log("Agregando: ", response[i][1])
                                }
                            },
                            error: function(response){alert("error")}
                        });

                    }
                });
        
            });
              
            $(document).on('click', ".GrupIMG", function() {

                console.log("Id de usuario: ", idUsuarioLogueado);
                console.log($(this).attr('id') + ": " + $(this).data('elNombre'));
                $('#lblNombreGrupo').html("_"+$(this).data('elNombre')+"");
                $('#lblDescripcionGrupo').html("_"+$(this).data('laDescripcion')+"");
                $('#lblIdGrupo').html("_"+$(this).data('idGrupo'));
                idGrupoActual = $(this).data('idGrupo');
                if($(this).attr('id') == "IMGagregar"){
                    console.log("CLICKITO");
                    if($('#divAgregarGrupo').is(':visible')){
                        $('#divAgregarGrupo').hide();
                    }
                    else{
                        $('#divAgregarGrupo').show();
                    }
                }
                else{
                    $('#divAgregarGrupo').hide();
                    if(uDataGlobal[$(this).data('posEnArray')][3] == 'creador'){
                        $('#divAdminGrupo').show();
                    }
                    else{
                        $('#divAdminGrupo').hide();
                    }    
                }
                $.ajax({
                    url:'cargarReferenciaTest', 
                    type:'POST',
                    data:{
                        "grupo": idGrupoActual,
                    },
                    success: function(response){
                        console.log(response.length)
                        if(response.length != 0){
                            $("#divUnaRef").hide()
                            for(i=0;i<response.length;i++){
                                $("#divContenedorReferencias").append("<div class='referencia'></div>")
                            }
                            console.log(response["cita"])
                            $("#lblCita").html(response["cita"])
                            $("#lblDescripcion").html(response["descripcion"])
                            $("#lblFecha").html(response["fecha"])
                            $("#lblLink").html(response["link"])
                            $("#lblUsuario").html(response["usuario"])

                            $("#divUnaRef").show()
                        }
                        else
                        {
                            $("#divUnaRef").show()
                            $("#divUnaRef").html("no hay ninguna cita en el grupo")
                        }

                    },
                    error: function(response){
                        console.log(response)
                    },

                })
            });
function primeraCarga(){
    console.log("Esto se imprime 1 vez en la primera cargas");
    $("#lblUsuarioLogueado").html(String(idUsuarioLogueado));
    $("#lblIdGrupo").html(idGrupoActual);
}
function tstResponse(){
    $.ajax({
        url: 'traerR',
        type: 'POST',
        data:{

        },
        success: function(response){
            console.log("dale bien");
            console.log(response)},
        error:  function(response){
            console.log("dale putooo");
            console.log(response)},
    });
}
function agregarGrupo(){
    console.log("Creando Grupo:", idUsuarioLogueado)
    $.ajax({
        url: 'crearGrupo',
        type: 'POST',
        data:{
            "nombreGrupo": $("#txtNombreDelGrupo").val(),
            "descripcion": $("#txtDescripcionDelGrupo").val(),
            "usuarioCredor": idUsuarioLogueado,
        },
        success: function(response){
            console.log("bien")
            console.log(response)
        },
        error: function(response){
            console.log("bien PERO CON ERROS")
            console.log(response)
        },
    });
}


function publicarReferencia(){
if($("#cita").val() == "" || $("#cita").val().localeCompare("Escriba aqui") == 0){
  alert("Debe ingresar una cita");
}
else if($("#descripcion").val() == "" || $("#descripcion").val().localeCompare("Escriba aqui") == 0){
  alert("Debe ingresar una descripcion");
}
else if($("#link").val() == "" || $("#link").val().localeCompare("Escriba aqui") == 0){
  alert("Debe ingresar un link");
}
else{
    console.log("este es mi json")
    console.log("idUsuarioLogueado: ", idUsuarioLogueado)
    console.log("grupo: ", idGrupoActual)
    console.log("cita: ", $("#cita").val())
    console.log("descripcion:",$("#descripcion").val())
    console.log("link: ",$("#link").val())
    console.log("tags:", "algo")
    $.ajax({
        url : "publicarReferencia",
        type : "POST",
        data : {
          usuario : idUsuarioLogueado,
          grupo : idGrupoActual,
          cita : $("#cita").val(),
          descripcion : $("#descripcion").val(),
          link : $("#link").val(),
          tags : "algo",
        },
        success: function(response){
            console.log(response);
        },
        error: function(response){
            alert("Error al cargar la referencia");
        }
    });
}
}

function invitarUsuarioAGrupo(){
    console.log("Invitando a:", $("#txtMailDeUsuario").val(), "al grupo:", idGrupoActual);
    $.ajax({
        url: 'invitarUsuario',
        type: 'POST',
        data: {
            "mailDeUsuario": $("#txtMailDeUsuario").val(),
            "idDelGrupo": idGrupoActual,
            "permisoUsuario": "lectura",

        },
        success: function(response){
            console.log("Bien, Revisa el response")
            console.log(response)
        },
        error: function(response){
            console.log("Mal, Rev Resp")
            console.log(response)
        }
    });

}
            
        </script>
        <link rel="stylesheet" href="static/css/estilos.css" />
    </head>

    <style type="text/css">

    </style>
    
    <div id="includedContent"></div>

    <body>
            <div id="columnaIzquierda">
                Grupos:           
            </div>
            <div id="columnaDerecha">
                <div id="divGrupoActual" class="referencia">
                    <div class="clsTitulo"> <label id="lblNombreGrupo"></label></div>
                    <div class="container">
                        Descripcion del Grupo:<label id="lblDescripcionGrupo"></label><br>
                        ID Del Grupo:<label id="lblIdGrupo"></label><br>
                        Usuario Logueado: <label id="lblUsuarioLogueado"></label><br>
                        
                    </div>
                </div>
                <div id="divAgregarGrupo" class="referencia">
                    <div class="clsTitulo"> Creacion de Grupos</div>
                    <div class="container">
                        <div class="refColumnaIzquierda">
                            Nombre Del Grupo:<br>
                            <input id="txtNombreDelGrupo" type="text" name=""><br>
                            Descripcion Del Grupo:<br>
                            <input id="txtDescripcionDelGrupo" type="text" name=""><br>
                            Fotico:<br>
                            <input type="text" name=""><br>
                            <button id="btnCrearGrupo" class="btn btn-primary">Crear Grupo</button>
                        </div>
                        <div class="refColumnaDerecha">
                            

                        
                        </div>
                    </div>
                </div>
                <div div id="divPublicarReferencia" class="referencia">
                    <h1 >Publicar</h1>
                    <br>
                    <p>Referencia:</p> 
                    Cita: <input type="text" id="cita" value="Escriba aqui"><br>
                    Descripcion : <input type="text" id="descripcion" value="Escriba aqui"><br>
                    Link: <input type="text" id="link" value="Escriba aqui"><br>
                    <button id="btnEnviar" class="btn btn-primary">Publicar</button>
                </div>
                
                <div id="divAdminGrupo" class="referencia">
                    <div class="clsTitulo"> Panel de control... MATAR USUARIOS</div>
                    <div class="container">
                        Invitar USUSARIO:<br>
                        <input id="txtMailDeUsuario" type="text" name=""><br>
                        ste inmp no lo uso:<br>
                        <input type="text" name=""><br>
                        Este tampoco:<br>
                        <input type="text" name=""><br>
                        <button id="btnInvitarUsuario" class="btn btn-primary">Invitar</button>
                    </div>
                </div>
                <div id="divContenedorReferencias">
                    <div id="divSinRef" class="referencia" >
                    </div>
                </div>

            </div>
    </body>
            
</html>
